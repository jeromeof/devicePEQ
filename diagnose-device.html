<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FiiO K13 R2R Device Diagnostics</title>
  <style>
    body {
      font-family: 'Consolas', 'Monaco', monospace;
      margin: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #252526;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    h1 {
      color: #4ec9b0;
      border-bottom: 2px solid #4ec9b0;
      padding-bottom: 10px;
    }
    h2 {
      color: #569cd6;
      margin-top: 20px;
    }
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 5px;
      transition: background 0.3s;
    }
    button:hover {
      background: #1177bb;
    }
    button:disabled {
      background: #3c3c3c;
      cursor: not-allowed;
    }
    .info-box {
      background: #1e1e1e;
      border: 1px solid #3c3c3c;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .success {
      color: #4ec9b0;
      font-weight: bold;
    }
    .error {
      color: #f48771;
      font-weight: bold;
    }
    .warning {
      color: #dcdcaa;
      font-weight: bold;
    }
    .key {
      color: #9cdcfe;
    }
    .value {
      color: #ce9178;
    }
    .code-block {
      background: #1e1e1e;
      border-left: 3px solid #4ec9b0;
      padding: 15px;
      margin: 15px 0;
      font-family: 'Consolas', monospace;
      overflow-x: auto;
    }
    #output {
      min-height: 100px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç FiiO K13 R2R Device Diagnostics</h1>
    
    <p>This tool will help diagnose why your K13 R2R isn't connecting properly.</p>
    
    <h2>Step 1: Connect Device</h2>
    <button id="connectBtn" onclick="connectDevice()">üîå Connect to K13 R2R</button>
    
    <h2>üìä Diagnostic Results:</h2>
    <div id="output" class="info-box">
      <span class="warning">‚è≥ Waiting for device connection...</span>
    </div>
    
    <h2>‚úÖ Configuration Fix:</h2>
    <div id="configFix" class="info-box">
      <span class="warning">Connect device first to generate config...</span>
    </div>
    
    <button id="copyBtn" onclick="copyConfig()" style="display:none;">üìã Copy Config to Clipboard</button>
    <button id="testBtn" onclick="testCommunication()" style="display:none;">üß™ Test Communication</button>
  </div>

  <script>
    let selectedDevice = null;
    let correctConfig = null;

    async function connectDevice() {
      const output = document.getElementById('output');
      const configFix = document.getElementById('configFix');
      
      try {
        output.innerHTML = '<span class="warning">‚è≥ Opening device picker...</span>';
        
        // Request FiiO devices
        const devices = await navigator.hid.requestDevice({
          filters: [
            { vendorId: 0x2972 }, // FiiO vendor ID
            { vendorId: 0x0A12 }  // Alternate FiiO vendor ID
          ]
        });
        
        if (devices.length === 0) {
          output.innerHTML = '<span class="error">‚ùå No device selected</span>';
          return;
        }
        
        selectedDevice = devices[0];
        
        // Open the device
        if (!selectedDevice.opened) {
          await selectedDevice.open();
        }
        
        // Get detailed device information
        const deviceInfo = {
          productName: selectedDevice.productName,
          manufacturer: selectedDevice.manufacturerString || "FiiO",
          vendorId: "0x" + selectedDevice.vendorId.toString(16).toUpperCase(),
          productId: "0x" + selectedDevice.productId.toString(16).toUpperCase(),
          opened: selectedDevice.opened,
          collections: selectedDevice.collections
        };
        
        // Display results
        let html = '<span class="success">‚úÖ Device Connected Successfully!</span>\n\n';
        html += '<span class="key">Product Name:</span> <span class="value">"' + deviceInfo.productName + '"</span>\n';
        html += '<span class="key">Manufacturer:</span> <span class="value">"' + deviceInfo.manufacturer + '"</span>\n';
        html += '<span class="key">Vendor ID:</span> <span class="value">' + deviceInfo.vendorId + '</span>\n';
        html += '<span class="key">Product ID:</span> <span class="value">' + deviceInfo.productId + '</span>\n';
        html += '<span class="key">Device Opened:</span> <span class="value">' + deviceInfo.opened + '</span>\n\n';
        
        html += '<span class="key">HID Collections:</span>\n';
        deviceInfo.collections.forEach((col, idx) => {
          html += `  Collection ${idx}:\n`;
          html += `    Usage Page: 0x${col.usagePage.toString(16).toUpperCase()}\n`;
          html += `    Usage: 0x${col.usage.toString(16).toUpperCase()}\n`;
          if (col.inputReports?.length) {
            html += `    Input Reports: ${col.inputReports.map(r => `${r.reportId} (size: ${r.items?.[0]?.reportSize || 'unknown'})`).join(', ')}\n`;
          } else {
            html += `    Input Reports: None\n`;
          }
          if (col.outputReports?.length) {
            html += `    Output Reports: ${col.outputReports.map(r => `${r.reportId} (size: ${r.items?.[0]?.reportSize || 'unknown'})`).join(', ')}\n`;
          } else {
            html += `    Output Reports: None\n`;
          }
          if (col.featureReports?.length) {
            html += `    Feature Reports: ${col.featureReports.map(r => `${r.reportId} (size: ${r.items?.[0]?.reportSize || 'unknown'})`).join(', ')}\n`;
          }
        });
        
        output.innerHTML = html;
        
        // Generate configuration fix
        const exactProductName = deviceInfo.productName;
        const reportId = deviceInfo.collections[0]?.outputReports?.[0]?.reportId;
        const reportIdToUse = (reportId !== undefined) ? reportId : 0;
        
        correctConfig = `"${exactProductName}": {
  modelConfig: {
    minGain: -12,
    maxGain: 12,
    maxFilters: 10,
    firstWritableEQSlot: 7,
    maxWritableEQSlots: 3,
    disconnectOnSave: false,
    disabledPresetId: 11,
    reportId: ${reportIdToUse},
    availableSlots: [
      {id: 0, name: "Jazz"},
      {id: 1, name: "Pop"},
      {id: 2, name: "Rock"},
      {id: 3, name: "Dance"},
      {id: 5, name: "R&B"},
      {id: 6, name: "Classic"},
      {id: 7, name: "Hip-hop"},
      {id: 4, name: "USER1"},
      {id: 8, name: "USER2"},
      {id: 9, name: "USER3"}
    ]
  }
}`;
        
        let configHtml = '<span class="success">‚úÖ Configuration Generated!</span>\n\n';
        configHtml += '<span class="warning">‚ö†Ô∏è IMPORTANT: The device name MUST match exactly!</span>\n\n';
        configHtml += 'Current config key: <span class="value">"FIIO K13 R2R"</span>\n';
        configHtml += 'Actual device name: <span class="value">"' + exactProductName + '"</span>\n\n';
        
        if (exactProductName === "FIIO K13 R2R") {
          configHtml += '<span class="success">‚úÖ MATCH! The config key is correct.</span>\n\n';
          configHtml += '<span class="warning">The issue might be:</span>\n';
          configHtml += '  1. Wrong reportId (detected: ' + reportId + ')\n';
          configHtml += '  2. Device needs different slot IDs\n';
          configHtml += '  3. Communication protocol differs\n';
        } else {
          configHtml += '<span class="error">‚ùå MISMATCH! This is why it\'s not connecting.</span>\n\n';
          configHtml += '<span class="success">FIX: Replace the config in usbDeviceConfig.js with:</span>\n\n';
        }
        
        configHtml += '<div class="code-block">' + correctConfig + '</div>';
        
        configFix.innerHTML = configHtml;
        
        // Show buttons
        document.getElementById('copyBtn').style.display = 'inline-block';
        document.getElementById('testBtn').style.display = 'inline-block';
        
      } catch (error) {
        output.innerHTML = '<span class="error">‚ùå Error: ' + error.message + '</span>\n\n';
        output.innerHTML += 'Stack trace:\n' + error.stack;
      }
    }
    
    function copyConfig() {
      if (correctConfig) {
        navigator.clipboard.writeText(correctConfig).then(() => {
          alert('‚úÖ Configuration copied to clipboard!\n\nNow update usbDeviceConfig.js in the FiiO devices section.');
        });
      }
    }
    
    async function testCommunication() {
      if (!selectedDevice) {
        alert('Please connect device first!');
        return;
      }
      
      const output = document.getElementById('output');
      output.innerHTML += '\n\n<span class="warning">üß™ Testing FiiO communication protocol...</span>\n';
      
      try {
        // Test getting version (FiiO standard command)
        const versionCommand = new Uint8Array([0xBB, 0x0B, 0x00, 0x00, 0x0B, 0x00, 0x00, 0xEE]);
        
        // Listen for response
        selectedDevice.oninputreport = (event) => {
          const data = new Uint8Array(event.data.buffer);
          output.innerHTML += '<span class="success">‚úÖ Received response!</span>\n';
          output.innerHTML += 'Data: ' + Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ') + '\n';
        };
        
        // Get report ID - if no reports listed, try 0 (no report ID)
        const reportId = selectedDevice.collections[0]?.outputReports?.[0]?.reportId;
        const reportIdToUse = (reportId !== undefined) ? reportId : 0;
        
        output.innerHTML += 'Sending version request (reportId: ' + reportIdToUse + ')...\n';
        await selectedDevice.sendReport(reportIdToUse, versionCommand);
        
        // Wait for response
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        output.innerHTML += '\n<span class="success">‚úÖ Communication test complete!</span>\n';
        
      } catch (error) {
        output.innerHTML += '<span class="error">‚ùå Communication error: ' + error.message + '</span>\n';
      }
    }
  </script>
</body>
</html>

